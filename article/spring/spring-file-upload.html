<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport"
    content="width=device-width, initial-scale=1, user-scalable=no">
<link rel="stylesheet" href="../../stylesheets/styles.css">
<link rel="stylesheet" href="../../stylesheets/font-awesome.min.css">
<link rel="stylesheet" href="../../stylesheets/page.css">
<link href="../../javascripts/google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
<script src="../../javascripts/google-code-prettify/prettify.js"></script>
<title>Spring File Upload</title>
</head>
<body onload="prettyPrint()" class="bg">
<div class="fix-right-top switch-bg"><i class="icon-adjust"></i></div>
<article>

<h2 id="spring-multipart-form">Spring 文件上传(multipart form)支持</h2>
<p>文件上传在许多系统中都会涉及到，首先我们要明白文件上传到服务器和普通表单内容提交到服务器的区别，然后理解服务器如何处理文件上传的request请求，最后可以解析上传的文件，比如文件名称、文件大小等。本文简要的一步步来完成一个简单的demo。</p>
<h6 id="form">文件上传的表单form</h6>
<p>在html的form标签中，有个enctype属性，规定在发送到服务器之前应该如何对表单数据进行编码。默认的值为 <code>application/x-www-form-urlencoded</code>,表示在发送前对所有字符进行编码。然而对于具有文件上传控件的表单，我们需要使用属性值 <code>multipart/form-data</code>  </p>
<!--?prettify lang=html?-->

<pre><code>&lt;form method="post" action="/upload" enctype='multipart/form-data'&gt;
    &lt;input  type="file" name="sayiFile" /&gt;
    &lt;button  type="submit"&gt;确 认 上 传&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>通过浏览器的开发者工具，可以看到提交表单时的请求体：  </p>
<pre><code>------WebKitFormBoundarySTanp4irBqKRx839
Content-Disposition: form-data; name="file"; filename="sayi.jpg"
Content-Type: image/jpeg

------WebKitFormBoundarySTanp4irBqKRx839--
</code></pre>
<h6 id="spring">Spring 处理上传请求</h6>
<p>在代码中我们可以自己解析上传表单的请求，Spring也提供了内建的实现方式，通过MultipartResolver实现对上传请求的装饰，这个解析器对每个请求进行multipart的检查，如果在请求中包含multipart，解析器将会把HttpServletRequest包装成MultipartHttpServletRequest。内建的类为 <code>StandardServletMultipartResolver</code> 和 <code>CommonsMultipartResolver</code> ,前者基于servlet3.0，后者需要额外的jar包 <strong>commons-fileupload-1.2.1.jar</strong> 及其依赖包。在applicationContext.xml配置解析器如下：  </p>
<!--?prettify lang=xml?-->

<pre><code>&lt;bean id="multipartResolver"
    class="org.springframework.web.multipart.commons.CommonsMultipartResolver"&gt;
    &lt;!-- &lt;property name="maxUploadSize"value="100000"/&gt; //不符合大小要求，服务器将抛出异常，我们更希望友好的提示用户--&gt;
&lt;/bean&gt;
</code></pre>
<h6 id="_1">解析上传的文件</h6>
<p>基于注解的控制器中，<code>@RequestParam("sayiFile") MultipartFile file</code>这样的参数就可以获取到上传的文件了。通过MultipartFile可以获得更多有关文件的信息。  </p>
<!--?prettify lang=java?-->

<pre><code>String getName();  获取表单的文件控件名称
String getOriginalFilename();  获取上传文件的名称
String getContentType(); 
boolean isEmpty(); 
long getSize();
InputStream getInputStream() throws IOException;
void transferTo(File dest) throws IOException, IllegalStateException;
</code></pre>

</article>
<script src="../../javascripts/jquery-1.8.0.min.js"></script>
<script type="text/javascript">
    $(function(){
        $(".switch-bg").click(function(){
            $("body").toggleClass("bg");
        });
    })
</script>
</body>
</html>